<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        canvas {
            border: 1px solid red;
        }
    </style>
</head>
<body>
    <main id="main">
        <canvas id="canvas"></canvas>
        <canvas id="canvas_2"></canvas>
    </main>
</body>
<script>
    const countEl = 100;
    let masElem = [];
    let masImag = [];
    let masPromis = [];
    let masUrlImg = [
    	'img/serfing.jpg',
        'img/snow.png',
        'img/kit.jpg'
    ];

    let canvas = document.getElementById('canvas');
    canvas.setAttribute('width', 800);
    canvas.setAttribute('height', 500);
    let ctx = canvas.getContext('2d');

    masUrlImg.forEach( x => { masPromis.push(loadImage(x)) });
    let ppp;
    Promise.all(masPromis).then( result => {
        
	    masImag = result.map( zn => zn );

	    for (let i = 0; i < countEl; i++) {

	    	let sizeEl = Math.random() * 50 + 50;
	    	let posX = Math.random() * 800 - 100;
	    	let posY = Math.random() * 400 - 420;
	    	let agle = Math.random() * 360;
	    	let agleSpeed = Math.random() * 0.5;
	    	let transX = Math.random() * 0.1 + 0.1;
	    	let transY = Math.random() * 0.5 + 0.5;

		    masElem.push(new elemImgCanvas(
			    masImag[1],
			    sizeEl,
			    sizeEl,
			    posX,
			    posY,
			    agle,
			    agleSpeed,
			    transX,
			    transY
		    ));
        }

        if (ctx) animRotation();
    });



    let canvas_2 = document.getElementById('canvas_2');
    canvas_2.setAttribute('width', 800);
    canvas_2.setAttribute('height', 500);
    let ctx_2 = canvas_2.getContext('2d');

    function loadImage(src) {
        let img = new Image();
        img.src = src;
        return new Promise( (resolve, reject) => {
	        img.onload = function () {
	            resolve(img);
            }
        });
    }
    
    function animRotation() {
	    ctx.clearRect(0, 0, ctx.canvas.offsetWidth, ctx.canvas.offsetHeight);

	    masElem.forEach( el => {

            ctx.translate(el.posX, el.posY);
            ctx.rotate(inRad(el.angle));
    //        debugger
            ctx.drawImage(el.img, -el.width/2, -el.height/2, el.width, el.height);
            ctx.rotate(inRad(-el.angle));
            ctx.translate(-el.posX, -el.posY);

            el.angle += el.speedAngle;

            if (el.posX - el.width > ctx.canvas.offsetWidth) {
                el.posX = Math.random() * ctx.canvas.offsetWidth;
	            el.posY = -el.height/2;
            } else {
                el.posX += el.transX;
            }

            if (el.posY - el.height/2 > ctx.canvas.offsetHeight) {
                el.posY = -el.height/2;
            } else {
                el.posY += el.transY;
            }

            ctx.globalCompositeOperation = 'source-in';
            ctx.drawImage(masImag[0], 0, 0);
            ctx.globalCompositeOperation = 'source-over';

            ctx_2.drawImage(masImag[2], 0, 0);
            ctx_2.drawImage(canvas, 0, 0);
        });

	    requestAnimationFrame( animRotation )
    }

    function inRad(num) {
	    return num * Math.PI / 180;
    }

    function elemImgCanvas(img, height, width, posX, posY, angle, speedAngle, transX, transY) {
    	this.img = img;
	    this.width = width;
	    this.height = height;
    	this.posX = posX;
    	this.posY = posY;
    	this.angle = angle;
    	this.speedAngle = speedAngle;
    	this.transX = transX;
    	this.transY = transY;
    }
</script>
</html>